<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Consultar — SGF</title>

  <link rel="stylesheet" href="assets/css/style.css" />

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
      /* Centralização geral */
      body {
        text-align: center;
        padding-bottom: 80px; /* Espaço para o rodapé fixo */
      }

      .caixa {
        margin: 0 auto;
      }

      .hero input.input {
        height: 44px;
        width: 280px;
        min-width: 200px; /* Evita desalinhamento em telas pequenas */
        text-align: center;
        box-sizing: border-box; /* Inclui padding/border na largura */
      }

      /* Alinhamento da barra de busca */
      .hero .barra-busca {
        display: flex;
        justify-content: center;
        align-items: center; /* Alinha verticalmente */
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 25px;
      }

      .hero .barra-busca .btn {
        min-width: 100px; /* Largura consistente para botões */
        box-sizing: border-box;
      }

      table th, table td {
        text-align: center !important;
      }

      footer {
        background: #0b2d5a;
        color: #fff;
        padding: 20px 0;
        text-align: center;
        font-size: 0.95rem;
        position: fixed; /* Fixa no fundo */
        bottom: 0;
        left: 0;
        width: 100%;
        z-index: 1000; /* Garante que fique acima de outros elementos */
      }
  </style>

</head>

<body>

<!-- ========================= -->
<!--   HERO / CABEÇALHO       -->
<!-- ========================= -->
<section class="hero" style="padding: 60px 20px;">
    <div class="caixa" style="max-width:1100px; width:100%; padding:40px;">

        <header style="margin-bottom:25px;">
            <img src="assets/img/logosovel1337.png" style="width:95px; margin-bottom:10px;" alt="logo" />
            <h1 style="font-size:2rem; margin:0; color:#123b7a;">Consulta de Ferramentais</h1>
            <p style="color:#4e4e4e;">Busque por SV, Nome ou NF-e</p>
        </header>

        <!-- ========================= -->
        <!--     BARRA DE BUSCA        -->
        <!-- ========================= -->
        <div class="barra-busca">
            <input id="busca" class="input" placeholder="Digite SV, Nome ou NF-e" />

            <button id="btnBuscar" class="btn">Consultar</button>
            <button id="btnExportCSV" class="btn ghost">Exportar CSV</button>
            <button id="btnExportPDF" class="btn">Exportar PDF</button>
            <button id="btnVoltar" class="btn ghost">Voltar</button>
        </div>

        <!-- ========================= -->
        <!--         TABELA            -->
        <!-- ========================= -->
        <div class="table-wrap" style="margin-top:20px; overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>Tipo</th>
                        <th>NF-e</th>
                        <th>SV</th>
                        <th>Nome</th>
                        <th>Data</th>
                        <th>Estado</th>
                        <th>Localização</th>
                        <th>Responsável</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="tabela"></tbody>
            </table>
        </div>
    </div>
</section>

<!-- ========================= -->
<!--         RODAPÉ            -->
<!-- ========================= -->
<footer>
    © 2025 Sovel da Amazônia — Todos os direitos reservados.
</footer>


<!-- ========================= -->
<!--          SCRIPT           -->
<!-- ========================= -->
<script type="module">
    console.log('Script de consultar.html iniciado'); // Log para confirmar execução

    try {
        import { buscarTodos, removerFerramental } from './assets/js/script.js';
        import { exportToCSV } from './assets/js/exporter.js';

        // Verifica se os elementos existem antes de anexar listeners
        const tabela = document.getElementById('tabela');
        const btnBuscar = document.getElementById('btnBuscar');
        const btnExportCSV = document.getElementById('btnExportCSV');
        const btnExportPDF = document.getElementById('btnExportPDF');
        const btnVoltar = document.getElementById('btnVoltar');

        if (!tabela || !btnBuscar || !btnExportCSV || !btnExportPDF || !btnVoltar) {
            console.error('Erro: Um ou mais elementos não encontrados no DOM.');
            alert('Erro interno: Elementos da página não carregaram corretamente.');
            return;
        }

        let currentList = [];

        function limparTabela(){ tabela.innerHTML = ''; }

        function montarLinha(item){
          const tr = document.createElement('tr');

          tr.innerHTML = `
            <td>${item.tipo || ''}</td>
            <td>${item.nfe || ''}</td>
            <td>${item.sv || ''}</td>
            <td>${item.nome || ''}</td>
            <td>${item.dataRegistro || ''}</td>
            <td>${item.estado || ''}</td>
            <td>${item.localizacao || ''}</td>
            <td>${(item.responsavel||'').split('@')[0] || ''}</td>
            <td class="actions">
              <button class="btn ghost editar">Editar</button>
              <button class="btn btn-danger excluir">Excluir</button>
              <button class="btn ghost qrbtn">QR</button>
              <button class="btn ghost qrExport">Exportar QR</button>
            </td>
          `;

          tr.querySelector('.editar').onclick = () =>
            location.href = `editar.html?id=${item.id}`;

          tr.querySelector('.excluir').onclick = async () => {
            const res = await Swal.fire({
              icon:'warning',
              title:'Excluir?',
              text:'Deseja realmente excluir esse registro?',
              showCancelButton:true
            });

            if (res.isConfirmed) {
              const ok = await removerFerramental(item.id);
              if(ok) tr.remove();
            }
          };

          tr.querySelector('.qrbtn').onclick = () => gerarQR(item);
          tr.querySelector('.qrExport').onclick = () => exportarQR(item);

          return tr;
        }

        async function carregarTodos(){
          try {
            limparTabela();
            const arr = await buscarTodos();
            currentList = arr;

            if(arr.length === 0)
              tabela.innerHTML = '<tr><td colspan="9">Nenhum ferramental cadastrado</td></tr>';
            else
              arr.forEach(i => tabela.appendChild(montarLinha(i)));
          } catch (error) {
            console.error('Erro ao carregar dados:', error);
            Swal.fire({ icon: 'error', title: 'Erro', text: 'Falha ao carregar dados. Verifique a configuração do Firebase.' });
          }
        }

        btnBuscar.onclick = () => {
          console.log('Botão Consultar clicado'); // Log para depuração
          const termo = document.getElementById('busca').value.trim().toLowerCase();
          if(!termo) return carregarTodos();

          const filtrados = currentList.filter(it =>
            (it.sv && it.sv.toLowerCase().includes(termo)) ||
            (it.nome && it.nome.toLowerCase().includes(termo)) ||
            (it.nfe && it.nfe.toLowerCase().includes(termo))
          );

          limparTabela();

          if(filtrados.length === 0)
            tabela.innerHTML = '<tr><td colspan="9">Nenhum ferramental encontrado</td></tr>';
          else
            filtrados.forEach(i => tabela.appendChild(montarLinha(i)));
        };

        function gerarQR(item){
          const url = `${window.location.origin}/SGF/detalhes.html?id=${item.id}`;
          const temp = document.createElement('div');
          new QRCode(temp, { text: url, width:280, height:280 });

          const img = temp.querySelector('img');

          Swal.fire({
            title: `QR — ${item.nome}`,
            html: `<div style="display:flex; justify-content:center;">
                    <img src="${img.src}" style="width:220px"/>
                   </div>`,
            showConfirmButton:true
          });
        }

        function exportarQR(item){
            const url = `${window.location.origin}/SGF/detalhes.html?id=${item.id}`;
            const qrDiv = document.createElement('div');
            new QRCode(qrDiv, { text: url, width:600, height:600 });

            setTimeout(() => {
                const img = qrDiv.querySelector('img').src;
                const a = document.createElement('a');
                a.href = img;
                a.download = `QR_${item.sv || item.nome}.png`;
                a.click();
            }, 500);
        }

        btnExportCSV.onclick = () => {
          console.log('Botão Exportar CSV clicado'); // Log para depuração
          if(!currentList.length)
            return Swal.fire({ icon:'info', title:'Nada para exportar' });

          try {
            exportToCSV(currentList, 'ferramentais.csv');
          } catch (error) {
            console.error('Erro ao exportar CSV:', error);
            Swal.fire({ icon: 'error', title: 'Erro', text: 'Falha ao exportar CSV.' });
          }
        };

        btnExportPDF.onclick = () => {
          console.log('Botão Exportar PDF clicado'); // Log para depuração
          window.print();
        };

        btnVoltar.onclick = () => {
          console.log('Botão Voltar clicado'); // Log para depuração
          location.href = 'menu.html';
        };

        // Carrega os dados iniciais
        carregarTodos();

    } catch (error) {
        console.error('Erro ao importar ou executar script:', error);
        alert('Erro interno: Falha ao carregar dependências. Verifique os arquivos JS e Firebase.');
    }
</script>

</body>
</html>
