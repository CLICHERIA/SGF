<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Consultar Ferramentais</title>
<script type="module" src="./assets/js/script.js"></script>
<script type="module" src="./assets/js/exporter.js"></script>
<style>
  table { border-collapse: collapse; width: 100%; margin-top: 1em; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background-color: #f2f2f2; }
  button { margin: 2px; }
</style>
</head>
<body>

<h2>Consultar Ferramentais</h2>

<input type="text" id="busca" placeholder="Buscar por SV, Nome ou NFE">
<button id="btnBuscar">Buscar</button>
<button id="btnExportCSV">Exportar CSV</button>
<button id="btnVoltar">Voltar</button>

<table>
  <thead>
    <tr>
      <th>Tipo</th>
      <th>NFE</th>
      <th>SV</th>
      <th>Nome</th>
      <th>Data Registro</th>
      <th>Estado</th>
      <th>Localização</th>
      <th>Responsável</th>
      <th>Ações</th>
    </tr>
  </thead>
  <tbody id="tabela">
    <tr><td colspan="9">Carregando...</td></tr>
  </tbody>
</table>

<script type="module">
import { buscarTodos, removerFerramental } from './assets/js/script.js';
import { exportToCSV } from './assets/js/exporter.js';

const tabela = document.getElementById('tabela');
const btnBuscar = document.getElementById('btnBuscar');
const btnExportCSV = document.getElementById('btnExportCSV');
const btnVoltar = document.getElementById('btnVoltar');
const inputBusca = document.getElementById('busca');

let currentList = [];

// Carrega todos os ferramental
async function carregarTodos() {
    tabela.innerHTML = '';
    try {
        currentList = await buscarTodos();
        if (currentList.length === 0) {
            tabela.innerHTML = '<tr><td colspan="9">Nenhum ferramental cadastrado</td></tr>';
            return;
        }
        currentList.forEach(item => tabela.appendChild(montarLinha(item)));
    } catch(err) {
        console.error(err);
        tabela.innerHTML = `<tr><td colspan="9">Erro na consulta: ${err.message}</td></tr>`;
    }
}

// Monta linha da tabela
function montarLinha(item) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td>${item.tipo || ''}</td>
        <td>${item.nfe || ''}</td>
        <td>${item.sv || ''}</td>
        <td>${item.nome || ''}</td>
        <td>${item.dataRegistro || ''}</td>
        <td>${item.estado || ''}</td>
        <td>${item.localizacao || ''}</td>
        <td>${item.responsavel || ''}</td>
        <td>
            <button class="editar">Editar</button>
            <button class="excluir">Excluir</button>
        </td>
    `;
    tr.querySelector('.editar').onclick = () => alert("Editar: " + item.nome);
    tr.querySelector('.excluir').onclick = async () => {
        if(confirm("Deseja realmente excluir este registro?")) {
            await removerFerramental(item.id);
            tr.remove();
        }
    };
    return tr;
}

// Filtrar busca
btnBuscar.onclick = () => {
    const termo = inputBusca.value.trim().toLowerCase();
    const filtrados = currentList.filter(it =>
        (it.sv && it.sv.toLowerCase().includes(termo)) ||
        (it.nome && it.nome.toLowerCase().includes(termo)) ||
        (it.nfe && it.nfe.toLowerCase().includes(termo))
    );
    tabela.innerHTML = '';
    if(filtrados.length === 0) tabela.innerHTML = '<tr><td colspan="9">Nenhum ferramental encontrado</td></tr>';
    else filtrados.forEach(i => tabela.appendChild(montarLinha(i)));
};

// Export CSV
btnExportCSV.onclick = () => {
    if(currentList.length === 0) return alert("Nada para exportar");
    exportToCSV(currentList, "ferramentais.csv");
};

// Voltar
btnVoltar.onclick = () => location.href = "menu.html";

// Inicializa carregamento
carregarTodos();
</script>

</body>
</html>
